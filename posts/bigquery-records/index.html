<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>The practical use of repetition and definition levels in BigQuery - Peter Boone</title><meta name=keywords content="tech,bigquery,google"><meta name=description content="Google&rsquo;s Dremel paper is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about repetition and definition levels that are relevant to the every day use of BigQuery.
Columnar Data and Records The underlying storage format for BigQuery is columnar. One of the first pieces of advice given to people using BigQuery is to only select the rows that you need."><meta name=author content="Peter Boone"><link rel=canonical href=https://boonepeter.github.io/posts/bigquery-records/><link href=https://boonepeter.github.io/assets/css/stylesheet.min.69a0a2b5ef2f62289117c5e7895b832df501978d8dfb1274dc90509d9924b2bb.css integrity="sha256-aaCite8vYiiRF8XniVuDLfUBl42N+xJ03JBQnZkksrs=" rel="preload stylesheet" as=style><link rel=manifest href=https://boonepeter.github.io/site.webmanifest><link rel=icon href=https://boonepeter.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://boonepeter.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://boonepeter.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://boonepeter.github.io/apple-touch-icon.png><link rel=mask-icon href=https://boonepeter.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.108.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-125699184-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="The practical use of repetition and definition levels in BigQuery"><meta property="og:description" content="Google&rsquo;s Dremel paper is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about repetition and definition levels that are relevant to the every day use of BigQuery.
Columnar Data and Records The underlying storage format for BigQuery is columnar. One of the first pieces of advice given to people using BigQuery is to only select the rows that you need."><meta property="og:type" content="article"><meta property="og:url" content="https://boonepeter.github.io/posts/bigquery-records/"><meta property="article:published_time" content="2021-09-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="The practical use of repetition and definition levels in BigQuery"><meta name=twitter:description content="Google&rsquo;s Dremel paper is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about repetition and definition levels that are relevant to the every day use of BigQuery.
Columnar Data and Records The underlying storage format for BigQuery is columnar. One of the first pieces of advice given to people using BigQuery is to only select the rows that you need."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The practical use of repetition and definition levels in BigQuery","name":"The practical use of repetition and definition levels in BigQuery","description":"Google\u0026amp;rsquo;s Dremel paper is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about …","keywords":["tech","bigquery","google"],"articleBody":"Google’s Dremel paper is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about repetition and definition levels that are relevant to the every day use of BigQuery.\nColumnar Data and Records The underlying storage format for BigQuery is columnar. One of the first pieces of advice given to people using BigQuery is to only select the rows that you need.\nTo demonstrate, this query will process 817 GB of data:\nSELECT * FROM `bigquery-public-data.github_repos.commits`; Limiting the number of rows does not reduce the amount of data that is processed (this is still 817 GB):\nSELECT * FROM `bigquery-public-data.github_repos.commits` LIMIT 1000; In contrast, if you select commiier from this dataset, only 21.7 GB is processed:\nSELECT committer FROM `bigquery-public-data.github_repos.commits`; This also applies to RECORD fields. This only processes 12.8 GB:\nSELECT committer.email FROM `bigquery-public-data.github_repos.commits`; When reading about the repetition and definition levels in BigQuery’s data format, I realized that limiting the selection also applies to repeated fields.\nIn this dataset difference is an array. This query processes 612.7 GB:\nSELECT diff FROM `bigquery-public-data.github_repos.commits`, UNNEST(difference) AS diff; The real breakthrough I had was realizing that you can just select a field from the repeated record. This query only processes 1.7 MiB:\nSELECT diff.old_repo FROM `bigquery-public-data.github_repos.commits`, UNNEST(difference) AS diff; This could greatly reduce the amount of data you have to process if you are only interested in certain fields of the repeated record. In the above example, by selecting only the old_repo field we process 0.00027777777% of the data that we would have by selecting the entire record.\nRecord Depth According to the documentation, the maximum depth of nested repeated fields is 15. I don’t think many people will come up against that limit. Just to double check, this is what happens when you try to create a schema that has too many levels.\nThe error message: The Dremel paper says:\nLevels are packed as bit sequences. We only use as many bits as necessary; for example, if the maximum definition level is 3, we use 2 bits per definition level.\nI’m assuming the maximum definition level of 15 is to limit this information to a single byte (4 bits for repetition level and 4 bits for definition level).\nFurther Reading How BigQuery actually stores the data. Spoiler alert: it’s complicated and depends on what your data looks like. ","wordCount":"402","inLanguage":"en","datePublished":"2021-09-12T00:00:00Z","dateModified":"2021-09-12T00:00:00Z","author":{"@type":"Person","name":"Peter Boone"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://boonepeter.github.io/posts/bigquery-records/"},"publisher":{"@type":"Organization","name":"Peter Boone","logo":{"@type":"ImageObject","url":"https://boonepeter.github.io/favicon.ico"}}}</script></head><body class=single id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://boonepeter.github.io/ accesskey=h>Peter Boone</a>
<span class=logo-switches><span class=theme-toggle><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://boonepeter.github.io/archive/><span>Archives</span></a></li><li><a href=https://boonepeter.github.io/tags/><span>Tags</span></a></li><li><a href=https://buttondown.email/boonepeter><span>Subscribe</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>The practical use of repetition and definition levels in BigQuery</h1><div class=post-meta>September 12, 2021&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Peter Boone
&nbsp;·&nbsp;<a href=https://github.com/boonepeter/boonepeter.github.io/blob/master/content/posts/bigquery-records.md>Source</a></div></header><div class=post-content><p>Google&rsquo;s <a href=https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36632.pdf>Dremel paper</a> is an interesting read that explains some of the concepts that underlie BigQuery. I am still processing the paper and have noticed a few things about repetition and definition levels that are relevant to the every day use of BigQuery.</p><h2 id=columnar-data-and-records>Columnar Data and Records<a hidden class=anchor aria-hidden=true href=#columnar-data-and-records>#</a></h2><p>The underlying storage format for BigQuery is columnar. One of the first pieces of advice given to people using BigQuery is to only select the rows that you need.</p><p>To demonstrate, this query will process <strong>817 GB</strong> of data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>;
</span></span></code></pre></div><p>Limiting the number of rows does not reduce the amount of data that is processed (this is still <strong>817 GB</strong>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1000</span>;
</span></span></code></pre></div><p>In contrast, if you select <code>commiier</code> from this dataset, only <strong>21.7 GB</strong> is processed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> committer
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>;
</span></span></code></pre></div><p>This also applies to <code>RECORD</code> fields. This only processes <strong>12.8 GB</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> committer.email
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>;
</span></span></code></pre></div><p>When reading about the repetition and definition levels in BigQuery&rsquo;s data format, I realized that limiting the selection also applies to repeated fields.</p><p>In this dataset <code>difference</code> is an array. This query processes <strong>612.7 GB</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> diff
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>UNNEST</span>(difference) <span style=color:#66d9ef>AS</span> diff;
</span></span></code></pre></div><p>The real breakthrough I had was realizing that you can just select a field from the repeated record. This query only processes <strong>1.7 MiB</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> diff.old_repo
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>bigquery<span style=color:#f92672>-</span><span style=color:#66d9ef>public</span><span style=color:#f92672>-</span><span style=color:#66d9ef>data</span>.github_repos.commits<span style=color:#f92672>`</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>UNNEST</span>(difference) <span style=color:#66d9ef>AS</span> diff;
</span></span></code></pre></div><p>This could greatly reduce the amount of data you have to process if you are only interested in certain fields of the repeated record. In the above example, by selecting only the <code>old_repo</code> field we process 0.00027777777% of the data that we would have by selecting the entire record.</p><h2 id=record-depth>Record Depth<a hidden class=anchor aria-hidden=true href=#record-depth>#</a></h2><p>According to the <a href=https://cloud.google.com/bigquery/docs/nested-repeated#limitations>documentation</a>, the maximum depth of nested repeated fields is 15. I don&rsquo;t think many people will come up against that limit. Just to double check, this is what happens when you try to create a schema that has too many levels.</p><p><img src=/imgs/bigquery-records/nested_record_schema.png alt="Nested Record Schema"></p><p>The error message:
<img src=/imgs/bigquery-records/error.png alt=Error></p><p>The Dremel paper says:</p><blockquote><p>Levels are packed as bit sequences. We
only use as many bits as necessary; for example, if the maximum
definition level is 3, we use 2 bits per definition level.</p></blockquote><p>I&rsquo;m assuming the maximum definition level of 15 is to limit this information to a single byte (4 bits for repetition level and 4 bits for definition level).</p><h3 id=further-reading>Further Reading<a hidden class=anchor aria-hidden=true href=#further-reading>#</a></h3><ul><li><a href=https://cloud.google.com/blog/products/bigquery/inside-capacitor-bigquerys-next-generation-columnar-storage-format>How BigQuery <em>actually</em> stores the data</a>. Spoiler alert: it&rsquo;s complicated and depends on what your data looks like.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://boonepeter.github.io/tags/tech>tech</a></li><li><a href=https://boonepeter.github.io/tags/bigquery>bigquery</a></li><li><a href=https://boonepeter.github.io/tags/google>google</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://boonepeter.github.io/>Peter Boone</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
<span>&#183;</span>
<span><a href=https://buttondown.email/boonepeter>Subscribe</a></span></footer><a href=#top aria-label="go to top" title="Go to Top" accesskey=g><button class=top-link id=top-link type=button><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script src=https://boonepeter.github.io/assets/js/highlight.min.14feb2f019bbfe400c73e169354bb5dcbfab5cd41b3ee05da4cb155870a2914b.js integrity="sha256-FP6y8Bm7/kAMc+FpNUu13L+rXNQbPuBdpMsVWHCikUs="></script>
<script>hljs.initHighlightingOnLoad()</script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${t}']`).scrollIntoView({behavior:"smooth"})})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>